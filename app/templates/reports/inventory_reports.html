{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-capsule me-2"></i>Inventory Reports</h1>
            <p class="text-muted">Comprehensive inventory analysis and stock management</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('reports.reports') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Reports
            </a>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">Filter Options</h5>
        </div>
        <div class="card-body">
            <div class="btn-group" role="group">
                <a href="{{ url_for('reports.inventory_reports', filter='all') }}" 
                   class="btn btn-outline-primary {% if filter_type == 'all' %}active{% endif %}">
                    All Inventory
                </a>
                <a href="{{ url_for('reports.inventory_reports', filter='low_stock') }}" 
                   class="btn btn-outline-warning {% if filter_type == 'low_stock' %}active{% endif %}">
                    Low Stock
                </a>
                <a href="{{ url_for('reports.inventory_reports', filter='expired') }}" 
                   class="btn btn-outline-danger {% if filter_type == 'expired' %}active{% endif %}">
                    Expired
                </a>
                <a href="{{ url_for('reports.inventory_reports', filter='expiring_soon') }}" 
                   class="btn btn-outline-info {% if filter_type == 'expiring_soon' %}active{% endif %}">
                    Expiring Soon
                </a>
            </div>
        </div>
    </div>

    <!-- Inventory Summary -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="card-title">{{ medications|length }}</h3>
                    <p class="card-text mb-0">Total Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="card-title">
                        {% set low_stock_count = medications|selectattr('stock_quantity', '<=', 10)|list|length %}
                        {{ low_stock_count }}
                    </h3>
                    <p class="card-text mb-0">Low Stock</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-danger text-white text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="card-title">
                        {% set expired_count = medications|selectattr('expiry_date')|selectattr('expiry_date', 'lt', now)|list|length %}
                        {{ expired_count }}
                    </h3>
                    <p class="card-text mb-0">Expired</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white text-center border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="card-title">
                        {% set total_value = 0 %}
                        {% for med in medications %}
                            {% if med.price and med.stock_quantity %}
                                {% set total_value = total_value + (med.price * med.stock_quantity) %}
                            {% endif %}
                        {% endfor %}
                        MMK {{ "{:,.0f}".format(total_value) }}
                    </h3>
                    <p class="card-text mb-0">Total Value</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Inventory Details</h5>
            <a href="{{ url_for('reports.export_inventory_report', filter=filter_type) }}" 
               class="btn btn-success btn-sm">
                <i class="bi bi-download me-1"></i> Export to Excel
            </a>
        </div>
        <div class="card-body">
            {% if medications %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Generic Name</th>
                            <th>Manufacturer</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Category</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Total Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med in medications %}
                        {% set days_until_expiry = none %}
                        {% if med.expiry_date %}
                            {% set days_until_expiry = (med.expiry_date - now).days %}
                        {% endif %}
                        <tr class="{% if med.expiry_date and med.expiry_date < now %}table-danger
                                   {% elif med.stock_quantity <= 5 %}table-warning
                                   {% elif med.expiry_date and days_until_expiry <= 30 %}table-info{% endif %}">
                            <td class="fw-bold">{{ med.name }}</td>
                            <td>{{ med.generic_name or 'N/A' }}</td>
                            <td>{{ med.manufacturer or 'N/A' }}</td>
                            <td>MMK {{ "{:,.0f}".format(med.price) if med.price else 0 }}</td>
                            <td>
                                <span class="fw-bold">{{ med.stock_quantity }}</span>
                                {% if med.stock_quantity <= 5 %}
                                <span class="badge bg-warning ms-1">Low</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ med.category or 'N/A' }}</span>
                            </td>
                            <td>
                                {% if med.expiry_date %}
                                    {{ med.expiry_date.strftime('%Y-%m-%d') }}
                                    {% if days_until_expiry is not none %}
                                        <br><small class="text-muted">
                                            {% if days_until_expiry > 0 %}
                                                (in {{ days_until_expiry }} days)
                                            {% elif days_until_expiry == 0 %}
                                                (today)
                                            {% else %}
                                                ({{ -days_until_expiry }} days ago)
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if med.expiry_date %}
                                    {% if med.expiry_date < now %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% elif days_until_expiry <= 30 %}
                                        <span class="badge bg-warning">Expiring Soon</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">No Expiry</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold">
                                MMK {{ "{:,.0f}".format(med.price * med.stock_quantity) if med.price and med.stock_quantity else 0 }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Category Breakdown -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">Category Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Items</th>
                                            <th>Total Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set categories = {} %}
                                        {% for med in medications %}
                                            {% set category = med.category or 'Uncategorized' %}
                                            {% set item_value = (med.price * med.stock_quantity) if med.price and med.stock_quantity else 0 %}
                                            {% if category not in categories %}
                                                {% set _ = categories.update({category: {'count': 1, 'value': item_value}}) %}
                                            {% else %}
                                                {% set _ = categories[category].update({
                                                    'count': categories[category].count + 1, 
                                                    'value': categories[category].value + item_value
                                                }) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% for category, stats in categories.items() %}
                                        <tr>
                                            <td class="fw-bold">{{ category }}</td>
                                            <td>{{ stats.count }}</td>
                                            <td class="fw-bold">MMK {{ "{:,.0f}".format(stats.value) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">Stock Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Total Inventory Value
                                    <span class="badge bg-primary rounded-pill fs-6">
                                        {% set total_inventory_value = 0 %}
                                        {% for med in medications %}
                                            {% if med.price and med.stock_quantity %}
                                                {% set total_inventory_value = total_inventory_value + (med.price * med.stock_quantity) %}
                                            {% endif %}
                                        {% endfor %}
                                        MMK {{ "{:,.0f}".format(total_inventory_value) }}
                                    </span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Low Stock Items (≤5)
                                    <span class="badge bg-warning rounded-pill fs-6">
                                        {{ medications|selectattr('stock_quantity', '<=', 5)|list|length }}
                                    </span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Expired Items
                                    <span class="badge bg-danger rounded-pill fs-6">
                                        {{ medications|selectattr('expiry_date')|selectattr('expiry_date', 'lt', now)|list|length }}
                                    </span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Expiring Soon (30 days)
                                    <span class="badge bg-info rounded-pill fs-6">
                                        {% set expiring_soon_count = 0 %}
                                        {% for med in medications %}
                                            {% if med.expiry_date and med.expiry_date > now %}
                                                {% set days_until_expiry = (med.expiry_date - now).days %}
                                                {% if days_until_expiry <= 30 %}
                                                    {% set expiring_soon_count = expiring_soon_count + 1 %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ expiring_soon_count }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
                <h5 class="mt-3">No Inventory Data</h5>
                <p class="text-muted">No medications found for the selected filter.</p>
                <a href="{{ url_for('inventory.add_medication') }}" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle me-1"></i> Add Medication
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.table-danger { background-color: rgba(220, 53, 69, 0.1) !important; }
.table-warning { background-color: rgba(255, 193, 7, 0.1) !important; }
.table-info { background-color: rgba(23, 162, 184, 0.1) !important; }
.badge { font-size: 0.75em; }
.card { border-radius: 10px; }
.table th { border-top: none; font-weight: 600; }
</style>
{% endblock %}
