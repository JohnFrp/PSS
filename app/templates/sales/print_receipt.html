<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt - {{ sale.transaction_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icon.ico') }}">
    <style>
        @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .container { max-width: 100% !important; padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; }
            .btn { display: none !important; }
            .receipt { width: 80mm !important; margin: 0 auto !important; }
        }
        body { 
            font-family: 'Courier New', monospace; 
            background-color: #f8f9fa;
        }
        .receipt { 
            width: 80mm; 
            margin: 0 auto; 
            background: white;
        }
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .table-sm th, .table-sm td { padding: 0.25rem; font-size: 0.8rem; }
        .border-top { border-top: 1px dashed #ccc !important; }
        .receipt-line { 
            border-bottom: 1px dashed #ddd; 
            padding: 2px 0;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-12">
                <!-- Print Controls -->
                <div class="text-center mb-3 no-print">
                    <button onclick="printReceipt()" class="btn btn-primary btn-sm">
                        <i class="bi bi-printer"></i> Print Receipt
                    </button>
                    <button onclick="closeWindow()" class="btn btn-secondary btn-sm">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </div>

                <!-- Receipt Content -->
                <div class="card receipt">
                    <div class="card-body p-3">
                        <!-- Header -->
                        <div class="text-center mb-3">
                            <h5 class="mb-1"><strong>ကောင်းလာဘ်စံ</strong></h5>
                            <p class="mb-1" style="font-size: 0.8rem;">Pharmacy & Medical Supplies</p>
                            <p class="mb-1" style="font-size: 0.7rem;">Quality Healthcare Products</p>
                            <p class="mb-2" style="font-size: 0.7rem;">Tel: 09-697813773, 09-780193669</p>
                            <hr style="margin: 0.5rem 0; border-top: 2px dashed #000;">
                        </div>

                        <!-- Transaction Info -->
                        <div class="mb-2">
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Receipt:</span>
                                <span><strong>{{ sale.transaction_id }}</strong></span>
                            </div>
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Date:</span>
                                <span id="localDate">{{ sale.sale_date.strftime('%Y-%m-%d %H:%M:%S UTC') }}</span>
                            </div>
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Cashier:</span>
                                <span>{{ sale.user.username }}</span>
                            </div>
                        </div>

                        <!-- Customer Info -->
                        {% if sale.customer %}
                        <div class="border-top pt-1 mb-2">
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Customer:</span>
                                <span>{{ sale.customer.name }}</span>
                            </div>
                            {% if sale.customer.phone %}
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Phone:</span>
                                <span>{{ sale.customer.phone }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Items Header -->
                        <div class="border-top pt-1 mb-1">
                            <div class="receipt-line d-flex justify-content-between fw-bold">
                                <span>ITEMS</span>
                                <span>AMOUNT</span>
                            </div>
                        </div>

                        <!-- Items List -->
                        <div class="mb-2">
                            {% for item in sale.items %}
                            <div class="receipt-line">
                                <div class="fw-bold">{{ item.medication.name }}</div>
                                <div class="d-flex justify-content-between">
                                    <span>{{ item.quantity }} × {{ "{:,.0f}".format(item.unit_price) }}</span>
                                    <span class="fw-bold">{{ "{:,.0f}".format(item.total_price) }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Totals -->
                        <div class="border-top pt-1">
                            {% set subtotal = sale.total_amount + (sale.discount_amount or 0) - (sale.tax_amount or 0) %}
                            
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span>{{ "{:,.0f}".format(subtotal) }}</span>
                            </div>
                            
                            {% if sale.tax_amount and sale.tax_amount > 0 %}
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Tax:</span>
                                <span>{{ "{:,.0f}".format(sale.tax_amount) }}</span>
                            </div>
                            {% endif %}
                            
                            {% if sale.discount_amount and sale.discount_amount > 0 %}
                            <div class="receipt-line d-flex justify-content-between text-success">
                                <span>Discount:</span>
                                <span>-{{ "{:,.0f}".format(sale.discount_amount) }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="receipt-line d-flex justify-content-between border-top pt-1 fw-bold">
                                <span>TOTAL:</span>
                                <span>{{ "{:,.0f}".format(sale.total_amount) }}</span>
                            </div>
                            
                            <div class="receipt-line d-flex justify-content-between">
                                <span>Payment:</span>
                                <span class="text-uppercase">{{ sale.payment_method }}</span>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="border-top pt-2 text-center mt-2">
                            <p class="mb-1" style="font-size: 0.7rem;">Thank you for your purchase!</p>
                            <p class="mb-1" style="font-size: 0.6rem;">
                                See You Again ...
                            </p>                            
                        </div>

                        <!-- Barcode Space -->
                        <div class="text-center mt-2">
                            <div style="height: 30px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                                <span class="text-muted">Transaction ID: {{ sale.transaction_id }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Print Message -->
                <div class="text-center mt-3 no-print">
                    <p class="text-muted">This receipt is ready for printing. Click the print button above.</p>
                    <p class="text-muted">Local Time: <span id="currentLocalTime"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to convert UTC to local time
        function convertToLocalTime(utcDateString) {
            try {
                const utcDate = new Date(utcDateString);
                if (isNaN(utcDate.getTime())) {
                    console.error('Invalid date format:', utcDateString);
                    return utcDateString; // Return original if invalid
                }
                
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZoneName: 'short'
                };
                
                return utcDate.toLocaleString('en-US', options);
            } catch (error) {
                console.error('Error converting time:', error);
                return utcDateString;
            }
        }

        // Function to get current local time
        function getCurrentLocalTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZoneName: 'short'
            };
            return now.toLocaleString('en-US', options);
        }

        // Convert date on page load
        document.addEventListener('DOMContentLoaded', function() {
            const utcDateElement = document.getElementById('localDate');
            if (utcDateElement) {
                const utcDateString = utcDateElement.textContent;
                const localDateString = convertToLocalTime(utcDateString);
                utcDateElement.textContent = localDateString;
            }
            
            // Display current local time
            const currentTimeElement = document.getElementById('currentLocalTime');
            if (currentTimeElement) {
                currentTimeElement.textContent = getCurrentLocalTime();
                
                // Update current time every second
                setInterval(function() {
                    currentTimeElement.textContent = getCurrentLocalTime();
                }, 1000);
            }
        });

        // Manual print function
        function printReceipt() {
            // Ensure time is converted before printing
            const utcDateElement = document.getElementById('localDate');
            if (utcDateElement && !utcDateElement.textContent.includes('UTC')) {
                // Time already converted, proceed to print
                window.print();
            } else {
                // Convert time first, then print
                if (utcDateElement) {
                    const utcDateString = utcDateElement.textContent;
                    const localDateString = convertToLocalTime(utcDateString);
                    utcDateElement.textContent = localDateString;
                }
                setTimeout(() => window.print(), 100);
            }
        }

        // Manual close function
        function closeWindow() {
            window.close();
        }

        // Optional: Auto-convert and display time zone info
        function displayTimeZoneInfo() {
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const offset = new Date().getTimezoneOffset();
            const offsetHours = Math.abs(Math.floor(offset / 60));
            const offsetMinutes = Math.abs(offset % 60);
            const offsetSign = offset <= 0 ? '+' : '-';
            
            console.log('Local Time Zone:', timeZone);
            console.log('UTC Offset:', `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMinutes.toString().padStart(2, '0')}`);
        }

        // Display time zone info on load
        document.addEventListener('DOMContentLoaded', displayTimeZoneInfo);
    </script>
</body>
</html>
