{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Back Button and Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('sales.transactions') }}" class="btn btn-outline-secondary btn-sm mb-3">
                        <i class="fas fa-arrow-left me-1"></i> Back to Transactions
                    </a>
                    <h1><i class="fas fa-receipt me-2"></i>Transaction Details</h1>
                    <p class="text-muted mb-0">Detailed view of transaction #{{ sale.transaction_id }}</p>
                </div>
                <div>
                    <a href="{{ url_for('sales.print_receipt', sale_id=sale.id) }}" 
                       class="btn btn-primary" target="_blank">
                        <i class="fas fa-print me-1"></i> Print Receipt
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-start border-4 border-primary h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Amount</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">MMK {{ "{:,.0f}".format(sale.total_amount) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-start border-4 border-success h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">Items Sold</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ sale.items|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-capsule fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-start border-4 border-info h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">Transaction Date</div>
                            <div class="h6 mb-0 fw-bold text-gray-800">
                                <span class="local-date" data-utc-date="{{ sale.sale_date.isoformat() }}">
                                    {{ sale.sale_date.strftime('%Y-%m-%d %H:%M:%S UTC') }}
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card border-start border-4 border-warning h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">Payment Method</div>
                            <div class="h6 mb-0 fw-bold text-gray-800 text-capitalize">{{ sale.payment_method }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-credit-card fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Transaction Details -->
        <div class="col-lg-8">
            <!-- Items Table -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Items Purchased</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Medication</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in sale.items %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ item.medication.name }}</div>
                                        {% if item.medication.generic_name %}
                                        <small class="text-muted">{{ item.medication.generic_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>MMK {{ "{:,.0f}".format(item.unit_price) }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td class="fw-bold">MMK {{ "{:,.0f}".format(item.total_price) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transaction Notes -->
            {% if sale.notes %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-sticky-note me-2"></i>Notes</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ sale.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Customer and Payment Info -->
        <div class="col-lg-4">
            <!-- Customer Information -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-user me-2"></i>Customer Information</h5>
                </div>
                <div class="card-body">
                    {% if sale.customer %}
                    <div class="mb-3">
                        <strong>Name:</strong><br>
                        {{ sale.customer.name }}
                    </div>
                    {% if sale.customer.phone %}
                    <div class="mb-3">
                        <strong>Phone:</strong><br>
                        {{ sale.customer.phone }}
                    </div>
                    {% endif %}
                    {% if sale.customer.email %}
                    <div class="mb-3">
                        <strong>Email:</strong><br>
                        {{ sale.customer.email }}
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-user-slash fa-2x mb-2"></i>
                        <p>Walk-in Customer</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-receipt me-2"></i>Payment Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>MMK {{ "{:,.0f}".format(sale.total_amount + sale.discount_amount - (sale.tax_amount or 0)) }}</span>
                    </div>
                    
                    {% if sale.tax_amount and sale.tax_amount > 0 %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax ({{ sale.tax_rate or 0 }}%):</span>
                        <span>MMK {{ "{:,.0f}".format(sale.tax_amount or 0) }}</span>
                    </div>
                    {% endif %}
                    
                    {% if sale.discount_amount and sale.discount_amount > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Discount:</span>
                        <span>- MMK {{ "{:,.0f}".format(sale.discount_amount) }}</span>
                    </div>
                    {% endif %}
                    
                    <hr>
                    <div class="d-flex justify-content-between mb-2 fw-bold fs-5">
                        <span>Total:</span>
                        <span>MMK {{ "{:,.0f}".format(sale.total_amount) }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Payment Method:</span>
                        <span class="badge bg-{% if sale.payment_method == 'cash' %}success{% elif sale.payment_method == 'card' %}info{% elif sale.payment_method == 'digital' %}warning{% else %}secondary{% endif %} text-capitalize">
                            {{ sale.payment_method }}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <span>Cashier:</span>
                        <span class="fw-bold">{{ sale.user.username }}</span>
                    </div>
                </div>
            </div>

            <!-- Transaction Actions -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('sales.print_receipt', sale_id=sale.id) }}" 
                           class="btn btn-primary" target="_blank">
                            <i class="fas fa-print me-1"></i> Print Receipt
                        </a>
                        <a href="{{ url_for('sales.sales') }}?duplicate={{ sale.id }}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-copy me-1"></i> Duplicate Sale
                        </a>
                        {% if sale.payment_status != 'refunded' %}
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#refundModal">
                            <i class="fas fa-undo me-1"></i> Process Refund
                        </button>
                        {% else %}
                        <button class="btn btn-outline-danger" disabled>
                            <i class="fas fa-ban me-1"></i> Already Refunded
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refundModalLabel">Process Refund</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to process a refund for this transaction?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone. The refund will be recorded in the system.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmRefund">
                    <i class="fas fa-undo me-1"></i> Confirm Refund
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to convert UTC to local time
    function convertToLocalTime(utcDateString) {
        try {
            const utcDate = new Date(utcDateString);
            if (isNaN(utcDate.getTime())) {
                return utcDateString;
            }
            
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Yangon'
            };
            
            return utcDate.toLocaleString('en-US', options) + ' MMYT';
        } catch (error) {
            console.error('Error converting time:', error);
            return utcDateString;
        }
    }

    // Convert UTC dates to local time
    const dateElements = document.querySelectorAll('.local-date');
    dateElements.forEach(element => {
        const utcDateString = element.getAttribute('data-utc-date');
        if (utcDateString) {
            const localDateString = convertToLocalTime(utcDateString);
            element.textContent = localDateString;
        }
    });

    // Refund functionality
    document.getElementById('confirmRefund')?.addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
        
        // Simulate refund processing
        setTimeout(() => {
            alert('Refund functionality would be implemented here.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            bootstrap.Modal.getInstance(document.getElementById('refundModal')).hide();
        }, 2000);
    });
});
</script>

<style>
.card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.border-start {
    border-left: 4px solid !important;
}

.badge {
    font-size: 0.75em;
}

.local-date {
    font-weight: 500;
}
</style>
{% endblock %}
